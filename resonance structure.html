<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resonance Shooter - NO₂⁻ Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 45%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }
    .app {
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(500px, 840px);
      gap: 16px;
      width: 100%;
      max-width: 1180px;
    }
    .panel {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.7);
      padding: 18px 18px 16px;
    }
    .panel-header {
      margin-bottom: 10px;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }
    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }
    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(96, 165, 250, 0.7);
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.35), transparent);
      color: #bfdbfe;
      white-space: nowrap;
    }
    .section {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #e5e7eb;
    }
    .section-body {
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.5;
    }
    .tip-box {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(37, 99, 235, 0.12));
      border: 1px solid rgba(52, 211, 153, 0.3);
      font-size: 12px;
      color: #bbf7d0;
    }
    .lang-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .small-label {
      font-size: 11px;
      color: #6b7280;
    }

    .game-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .game-title {
      font-size: 16px;
      font-weight: 600;
    }
    .game-subtitle {
      font-size: 12px;
      color: #9ca3af;
    }
    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(96, 165, 250, 0.7);
      color: #bfdbfe;
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.35), transparent);
      white-space: nowrap;
    }

    canvas {
      display: block;
      width: 100%;
      max-width: 820px;
      height: auto;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at center, #020617 0%, #020617 55%, #000 100%);
    }

    .game-footer-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
      font-size: 12px;
      color: #e5e7eb;
    }
    .controls-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .controls span {
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(31, 41, 55, 0.95);
      border: 1px solid rgba(75, 85, 99, 0.9);
      margin-right: 4px;
      font-size: 11px;
    }
    .bar-container {
      flex: 1;
      min-width: 160px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(55, 65, 81, 0.9);
      height: 14px;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
      width: 100%;
      transform-origin: left center;
    }
    .status-text {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 6px;
      white-space: nowrap;
    }

    .mobile-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 4px;
    }
    .mobile-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(31, 41, 55, 0.96);
      color: #e5e7eb;
      font-size: 14px;
      cursor: pointer;
      min-width: 44px;
    }
    .mobile-btn:active {
      background: rgba(37, 99, 235, 0.9);
      border-color: rgba(96, 165, 250, 1);
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- 左边说明 -->
  <aside class="panel">
    <div class="panel-header">
      <div class="title">Resonance Shooter</div>
      <div class="subtitle">
        Shoot electron pairs to show valid resonance positions in NO₂⁻.
      </div>
      <div class="badge-row">
        <div class="badge">Topic: Resonance Structure</div>
        <div class="badge">Delocalised electrons · π bonds · Stability</div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Current Goal</div>
      <div class="tip-box">
        Hit both oxygen atoms with electron pairs to show that the π bond / negative charge can
        delocalise over the two O atoms in NO₂⁻.
      </div>
    </div>

    <div class="section">
      <div class="section-title">Learning Outcomes</div>
      <div class="section-body">
        • Understand that resonance structures for NO₂⁻ differ only in electron position, not atom position.<br/>
        • See that the negative charge and π bond can be shared (delocalised) over both oxygens.<br/>
        • Relate resonance to greater stability of the nitrite ion.
      </div>
    </div>

    <div class="section">
      <div class="section-title">Game Tips</div>
      <div class="section-body">
        • 电脑：用 <span class="highlight">← →</span> 或 A / D 移动下面的电子炮。<br/>
        • 手机：点下面的 ◀ ▶ 按钮移动。<br/>
        • 点画面或按 ● 按钮就会发射电子对子弹。<br/>
        • 打中左右两边氧原子附近的 target 就代表形成另外一个共振结构。<br/>
        • 射偏太多次，Resonance stability 会下降到 0 → Game Over。
      </div>
    </div>
  </aside>

  <!-- 右边游戏 -->
  <main class="panel">
    <div class="game-header-row">
      <div>
        <div class="game-title">NO₂⁻ Resonance Shooter</div>
        <div class="game-subtitle">
          Place electron pairs on both oxygens to show resonance.
        </div>
      </div>
      <div class="pill">Resonance · Interactive Simulation</div>
    </div>

    <canvas id="gameCanvas" width="820" height="460"></canvas>

    <div class="game-footer-row">
      <div class="controls-line">
        <div class="controls">
          <span>←</span><span>→</span> move &nbsp;
          Click / tap canvas or <span>●</span> to shoot &nbsp;
          <span>R</span> restart
        </div>
        <div style="display:flex;align-items:center;gap:4px;flex:1;justify-content:flex-end;">
          <div class="bar-container">
            <div id="stabilityBar" class="bar-fill"></div>
          </div>
          <div id="statusText" class="status-text">Resonance stability: 100%</div>
        </div>
      </div>
      <div class="mobile-buttons">
        <button class="mobile-btn" id="btn-left">◀</button>
        <button class="mobile-btn" id="btn-shoot">●</button>
        <button class="mobile-btn" id="btn-right">▶</button>
      </div>
    </div>
  </main>
</div>

<script>
  // --- 基本设定 ---
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;

  const keys = {};
  window.addEventListener("keydown", (e) => {
    keys[e.key.toLowerCase()] = true;
  });
  window.addEventListener("keyup", (e) => {
    keys[e.key.toLowerCase()] = false;
  });

  const stabilityBar = document.getElementById("stabilityBar");
  const statusText = document.getElementById("statusText");

  // 底部电子炮
  const cannon = {
    x: WIDTH / 2,
    y: HEIGHT - 50,
    width: 60,
    height: 14,
    speed: 260,
  };

  // 两个 target：左 O 和右 O
  const targets = [
    { x: 300, y: 210, hit: false },
    { x: 520, y: 210, hit: false },
  ];

  let bullets = [];
  let stability = 100;
  let gameOver = false;
  let levelCleared = false;
  let lastTime = null;
  let shootCooldown = 0;
  let showIntro = true;

  // 手机按键状态
  let leftPressed = false;
  let rightPressed = false;

  // --- 发射子弹 ---
  function shoot() {
    if (shootCooldown > 0 || gameOver || levelCleared) return;
    bullets.push({
      x: cannon.x,
      y: cannon.y - 10,
      vy: -350,
      r: 5,
      dead: false,
    });
    shootCooldown = 0.22;
    showIntro = false;
  }

  // 点击画布也可以发射（电脑 / 手机）
  canvas.addEventListener("click", () => {
    shoot();
  });

  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    shoot();
  });

  // 手机按钮：左 / 右 / 射击
  const btnLeft = document.getElementById("btn-left");
  const btnRight = document.getElementById("btn-right");
  const btnShoot = document.getElementById("btn-shoot");

  function bindHoldButton(btn, setFlag) {
    btn.addEventListener("mousedown", () => setFlag(true));
    btn.addEventListener("mouseup", () => setFlag(false));
    btn.addEventListener("mouseleave", () => setFlag(false));
    btn.addEventListener("touchstart", (e) => {
      e.preventDefault();
      setFlag(true);
    });
    btn.addEventListener("touchend", (e) => {
      e.preventDefault();
      setFlag(false);
    });
    btn.addEventListener("touchcancel", (e) => {
      e.preventDefault();
      setFlag(false);
    });
  }

  bindHoldButton(btnLeft, (v) => (leftPressed = v));
  bindHoldButton(btnRight, (v) => (rightPressed = v));

  btnShoot.addEventListener("click", (e) => {
    e.preventDefault();
    shoot();
  });
  btnShoot.addEventListener("touchstart", (e) => {
    e.preventDefault();
    shoot();
  });

  // 电脑也可以用 space 辅助发射
  window.addEventListener("keydown", (e) => {
    if (e.key === " ") {
      e.preventDefault();
      shoot();
    }
    if (e.key.toLowerCase() === "r") {
      resetGame();
    }
  });

  function resetGame() {
    cannon.x = WIDTH / 2;
    bullets = [];
    stability = 100;
    gameOver = false;
    levelCleared = false;
    lastTime = null;
    shootCooldown = 0;
    showIntro = true;
    targets.forEach((t) => (t.hit = false));
    stabilityBar.style.transform = "scaleX(1)";
    statusText.textContent = "Resonance stability: 100%";
  }

  // --- 画 NO2- 分子 ---
  function drawMolecule() {
    const N = { x: 410, y: 210 };
    const O1 = { x: 330, y: 210 };
    const O2 = { x: 490, y: 210 };

    ctx.lineWidth = 2;
    ctx.strokeStyle = "#e5e7eb";
    ctx.fillStyle = "#e5e7eb";
    ctx.font = "16px system-ui";
    ctx.textAlign = "center";

    // double bond to left O
    ctx.beginPath();
    ctx.moveTo(N.x - 6, N.y - 4);
    ctx.lineTo(O1.x + 6, O1.y - 4);
    ctx.moveTo(N.x - 6, N.y + 4);
    ctx.lineTo(O1.x + 6, O1.y + 4);
    ctx.stroke();

    // single bond to right O
    ctx.beginPath();
    ctx.moveTo(N.x + 6, N.y);
    ctx.lineTo(O2.x - 6, O2.y);
    ctx.stroke();

    // atoms
    ctx.fillText("O", O1.x, O1.y - 20);
    ctx.fillText("N", N.x, N.y - 20);
    ctx.fillText("O", O2.x, O2.y - 20);

    ctx.font = "12px system-ui";
    ctx.fillText("−", O2.x + 12, O2.y - 28);

    ctx.textAlign = "left";
    ctx.font = "11px system-ui";
    ctx.fillStyle = "#9ca3af";
    ctx.fillText("One valid resonance form of NO₂⁻", 60, 90);
  }

  // --- 更新逻辑 ---
  function update(dt) {
    if (gameOver || levelCleared) return;

    // 移动炮台：键盘 或 手机按钮
    if (keys["arrowleft"] || keys["a"] || leftPressed) {
      cannon.x -= cannon.speed * dt;
    }
    if (keys["arrowright"] || keys["d"] || rightPressed) {
      cannon.x += cannon.speed * dt;
    }
    cannon.x = Math.max(60, Math.min(WIDTH - 60, cannon.x));

    // 冷却时间
    if (shootCooldown > 0) {
      shootCooldown -= dt;
      if (shootCooldown < 0) shootCooldown = 0;
    }

    // 更新子弹
    bullets.forEach((b) => {
      b.y += b.vy * dt;
    });

    // 检查碰撞（子弹打中 target）
    bullets.forEach((b) => {
      if (b.dead) return;
      targets.forEach((t) => {
        if (t.hit) return;
        const dx = b.x - t.x;
        const dy = b.y - t.y;
        const dist = Math.hypot(dx, dy);
        if (dist < 20) {
          t.hit = true;
          b.dead = true;
        }
      });
      // 超出画面且没打中 → 稳定度下降
      if (!b.dead && b.y < 80) {
        b.dead = true;
        stability -= 10;
        if (stability < 0) stability = 0;
      }
    });

    bullets = bullets.filter((b) => !b.dead);

    stabilityBar.style.transform = `scaleX(${stability / 100})`;
    statusText.textContent = `Resonance stability: ${stability.toFixed(0)}%`;

    if (stability <= 0) {
      gameOver = true;
    }

    // 如果两个 target 都 hit → 过关
    if (targets.every((t) => t.hit)) {
      levelCleared = true;
    }
  }

  // --- 画画面 ---
  function drawBackground() {
    const grad = ctx.createLinearGradient(0, 0, WIDTH, HEIGHT);
    grad.addColorStop(0, "#020617");
    grad.addColorStop(1, "#000000");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, WIDTH, HEIGHT);
  }

  function drawTargets() {
    targets.forEach((t) => {
      const radius = 14;
      ctx.beginPath();
      if (t.hit) {
        const g = ctx.createRadialGradient(
          t.x, t.y, 3,
          t.x, t.y, radius + 4
        );
        g.addColorStop(0, "rgba(34, 197, 94, 0.9)");
        g.addColorStop(1, "rgba(22, 163, 74, 0.1)");
        ctx.fillStyle = g;
      } else {
        const g = ctx.createRadialGradient(
          t.x, t.y, 3,
          t.x, t.y, radius + 4
        );
        g.addColorStop(0, "rgba(248, 250, 252, 0.95)");
        g.addColorStop(1, "rgba(59, 130, 246, 0.15)");
        ctx.fillStyle = g;
      }
      ctx.arc(t.x, t.y, radius, 0, Math.PI * 2);
      ctx.fill();

      if (!t.hit) {
        ctx.strokeStyle = "rgba(59,130,246,0.9)";
        ctx.lineWidth = 1.2;
        ctx.stroke();
      }
    });
  }

  function drawCannon() {
    ctx.fillStyle = "#38bdf8";
    ctx.beginPath();
    ctx.roundRect(
      cannon.x - cannon.width / 2,
      cannon.y - cannon.height / 2,
      cannon.width,
      cannon.height,
      7
    );
    ctx.fill();

    // 小小炮管
    ctx.fillStyle = "#0ea5e9";
    ctx.fillRect(cannon.x - 4, cannon.y - cannon.height / 2 - 10, 8, 10);
  }

  function drawBullets() {
    bullets.forEach((b) => {
      ctx.beginPath();
      const g = ctx.createRadialGradient(
        b.x - 1, b.y - 2, 1,
        b.x, b.y, b.r + 3
      );
      g.addColorStop(0, "#e0f2fe");
      g.addColorStop(1, "#0ea5e9");
      ctx.fillStyle = g;
      ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  function drawOverlay() {
    ctx.textAlign = "center";
    if (showIntro && !gameOver && !levelCleared) {
      ctx.fillStyle = "rgba(15,23,42,0.88)";
      ctx.fillRect(130, 120, WIDTH - 260, 220);
      ctx.strokeStyle = "rgba(148,163,184,0.85)";
      ctx.strokeRect(130.5, 120.5, WIDTH - 261, 219);

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "20px system-ui";
      ctx.fillText("Resonance Shooter: NO₂⁻", WIDTH / 2, 160);

      ctx.font = "13px system-ui";
      ctx.fillStyle = "#cbd5f5";
      ctx.fillText(
        "Shoot electron pairs to show that both oxygens can share the negative charge.",
        WIDTH / 2,
        190
      );
      ctx.fillText(
        "Hit both targets near the O atoms to represent two resonance structures.",
        WIDTH / 2,
        210
      );

      ctx.fillStyle = "#94a3b8";
      ctx.fillText(
        "Use ← → or the ◀ ▶ buttons to move, then tap anywhere or press ● to shoot.",
        WIDTH / 2,
        240
      );

      ctx.fillStyle = "#bfdbfe";
      ctx.font = "14px system-ui";
      ctx.fillText("Tap to start playing", WIDTH / 2, 275);
    }

    if (gameOver) {
      ctx.fillStyle = "rgba(15,23,42,0.9)";
      ctx.fillRect(150, 150, WIDTH - 300, 180);
      ctx.strokeStyle = "rgba(148,163,184,0.9)";
      ctx.strokeRect(150.5, 150.5, WIDTH - 301, 179);

      ctx.fillStyle = "#fecaca";
      ctx.font = "22px system-ui";
      ctx.fillText("Resonance picture became unstable!", WIDTH / 2, 190);

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "14px system-ui";
      ctx.fillText(
        "Too many wrong shots. Think about where electrons can really be delocalised.",
        WIDTH / 2,
        220
      );
      ctx.fillStyle = "#bfdbfe";
      ctx.fillText("Press R to restart", WIDTH / 2, 250);
    }

    if (levelCleared) {
      ctx.fillStyle = "rgba(15,23,42,0.9)";
      ctx.fillRect(150, 150, WIDTH - 300, 180);
      ctx.strokeStyle = "rgba(148,163,184,0.9)";
      ctx.strokeRect(150.5, 150.5, WIDTH - 301, 179);

      ctx.fillStyle = "#bbf7d0";
      ctx.font = "22px system-ui";
      ctx.fillText("Great! Valid resonance positions found!", WIDTH / 2, 190);

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "14px system-ui";
      ctx.fillText(
        "Both oxygens can share the π bond / negative charge in NO₂⁻.",
        WIDTH / 2,
        220
      );
      ctx.fillStyle = "#bfdbfe";
      ctx.fillText("Press R to play again", WIDTH / 2, 250);
    }
    ctx.textAlign = "left";
  }

  // --- 主循环 ---
  function loop(timestamp) {
    if (!lastTime) lastTime = timestamp;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    update(dt);

    drawBackground();
    drawMolecule();
    drawTargets();
    drawCannon();
    drawBullets();
    drawOverlay();

    requestAnimationFrame(loop);
  }

  // 开始
  resetGame();
  requestAnimationFrame(loop);
</script>
</body>
</html>
